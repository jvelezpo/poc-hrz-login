steps:
- id: lint-yaml
  name: 'gcr.io/$PROJECT_ID/cloudbuilders/yamllint:1.20.0'
  args: ["-d", "relaxed", "."]
  waitFor: ['-']

- id: npm-install
  name: node:12
  secretEnv: ['NPM_TOKEN']
  entrypoint: npm
  args: ['i', '--quiet', '--package-lock-only']

- id: npm-audit
  name: 'gcr.io/$PROJECT_ID/cloudbuilders/audit-filter:0.5.0'
  secretEnv: ['NPM_TOKEN']
  entrypoint: "/bin/bash"
  args:
  - -c
  - npm audit --production --json | audit-filter
  waitFor:
  - 'npm-install'

- id: npm-ci
  name: node:12
  secretEnv: ['NPM_TOKEN']
  entrypoint: npm
  args: ['ci', '--quiet']
  waitFor:
  - 'npm-audit'

- id: docker-build
  name: 'gcr.io/$PROJECT_ID/cloudbuilders/docker:19.03.5'
  secretEnv: ['NPM_TOKEN']
  env:
  - 'BRANCH_NAME=$BRANCH_NAME'
  - 'BUILD_ID=$BUILD_ID'
  - 'PROJECT_ID=$PROJECT_ID'
  - 'REPO_NAME=$REPO_NAME'
  - 'REVISION_ID=$REVISION_ID'
  - 'SHORT_SHA=$SHORT_SHA'
  - 'TAG_NAME=$TAG_NAME'
  - '_PR_NUMBER=$_PR_NUMBER'

- id: npm-publish
  name: 'gcr.io/$PROJECT_ID/cloudbuilders/npm:6.13.4'
  secretEnv: ['NPM_TOKEN']
  env:
  - 'TAG_NAME=$TAG_NAME'
  - '_PR_NUMBER=$_PR_NUMBER'

images:
- 'gcr.io/${PROJECT_ID}/pagerinc/${REPO_NAME}'

timeout: 10m

logsBucket: 'gs://$PROJECT_ID-cloudbuild-logs'

tags:
- 'cli'
- 'docker'
- 'nodejs'

secrets:
- kmsKeyName: projects/production-197117/locations/global/keyRings/gcb/cryptoKeys/main
  secretEnv:
    NPM_TOKEN: 'CiQA/4lqmU8KYIPC16HLmSVWAykqoucvRDklsbpPnkZBaEkVdrUSTQC7Kyfra1qLGAJfz0e3I4lSAcihcZ8zotHFnOEo6CrLbX8RUeWV8luPwb9pRp/HOpsaopYdTo6AB4jjyU/5RP9zR2GPD5DTM7EFcc0M'
